generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  PENDING_ACTIVATION
  TRIAL
  ACTIVE
  SUSPENDED
  PAST_DUE
  CANCELED
}

enum UserRole {
  ADMIN_SAAS
  OWNER
  MANAGER
  MEMBER
}

enum MovementType {
  ENTRADA
  SAIDA_OS
  AJUSTE
}

enum OrderStatus {
  AGENDADO
  EM_VISTORIA
  EM_EXECUCAO
  AGUARDANDO_PAGAMENTO
  CONCLUIDO
  CANCELADO
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PaymentMethod {
  PIX
  CARTAO_CREDITO
  CARTAO_DEBITO
  DINHEIRO
  TRANSFERENCIA
}

enum NotificationType {
  AGENDAMENTO_CONFIRMADO
  VISTORIA_LINK
  SERVICO_CONCLUIDO
  LEMBRETE_RETORNO
}

// Tenant & Billing
model Tenant {
  id               String       @id @default(cuid())
  name             String
  slug             String       @unique
  logo             String?
  primaryColor     String       @default("#DC2626")
  secondaryColor   String       @default("#1F2937")
  status           TenantStatus @default(PENDING_ACTIVATION)
  plan             String       @default("pro_monthly")
  trialStartedAt     DateTime?
  trialEndsAt        DateTime?
  nextBillingAt      DateTime?
  customMonthlyPrice Decimal?   @db.Decimal(10, 2)
  isFoundingMember   Boolean    @default(false)
  billingCycleStart  DateTime?
  stripeCustomerId   String?
  phone            String?
  email            String?
  address          String?
  cnpj             String?
  pixKey           String?
  paymentTerms     String?      @db.Text
  contractTemplate String?      @db.Text
  maxDailyCapacity Int          @default(10)
  businessHours    String?      @db.Text
  inspectionRequired   String   @default("NONE")
  inspectionSignature  Boolean  @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  users            User[]
  customers        Customer[]
  vehicles         Vehicle[]
  services         Service[]
  products         Product[]
  orders           ServiceOrder[]
  settlements      CommissionSettlement[]
  notifications    NotificationLog[]
  messageTemplates MessageTemplate[]
  
  // Billing relations
  subscription     Subscription?
  promoCodes       PromoCode[]      @relation("PromoCodeOwner")
}

enum UserStatus {
  ACTIVE
  INVITED
  INACTIVE
}

model User {
  id                       String     @id @default(cuid())
  clerkId                  String?    @unique
  email                    String
  name                     String
  role                     UserRole   @default(MEMBER)
  status                   UserStatus @default(ACTIVE)
  avatarUrl                String?
  phone                    String?
  
  // HR Details
  jobTitle                 String?
  salary                   Decimal?   @db.Decimal(10, 2)
  admissionDate            DateTime?
  pixKey                   String? 
  defaultCommissionPercent Decimal?   @default(0) @db.Decimal(5, 2)
  
  tenantId                 String
  tenant                   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isActive                 Boolean    @default(true)
  createdAt                DateTime   @default(now())

  assignedOrders ServiceOrder[]          @relation("AssignedTo")
  createdOrders  ServiceOrder[]          @relation("CreatedBy")
  commissions    OrderItemCommission[]
  auditLogs      AuditLog[]

  @@index([tenantId])
  @@index([clerkId])
  @@index([email])
}

// Core Entities
model Customer {
  id            String    @id @default(cuid())
  name          String
  phone         String
  email         String?
  document      String?
  birthDate     DateTime?
  instagram     String?
  notes         String?
  whatsappOptIn Boolean   @default(true)
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  vehicles Vehicle[]
  orders   ServiceOrder[]

  @@index([tenantId, phone])
  @@index([tenantId, name])
  @@index([tenantId, email])
  @@index([tenantId, deletedAt])
}

model Vehicle {
  id         String    @id @default(cuid())
  plate      String
  brand      String
  model      String
  color      String
  year       Int?
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  orders ServiceOrder[]

  @@unique([tenantId, plate])
  @@index([tenantId])
}

// Catalog
model Service {
  id                       String   @id @default(cuid())
  name                     String
  description              String?
  basePrice                Decimal  @db.Decimal(10, 2)
  estimatedTime            Int?
  returnDays               Int?
  isActive                 Boolean  @default(true)
  defaultCommissionPercent Decimal? @default(0) @db.Decimal(5, 2)
  defaultCommissionFixed   Decimal? @db.Decimal(10, 2)
  tenantId                 String
  tenant                   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  @@index([tenantId])
  @@index([tenantId, isActive])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  sku         String?
  unit        String   @default("un")
  costPrice   Decimal? @db.Decimal(10, 2)
  salePrice   Decimal? @db.Decimal(10, 2)
  stock       Int      @default(0)
  minStock    Int      @default(5)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockMovements StockMovement[]
  orderProducts  OrderProduct[]

  @@index([tenantId])
}

model StockMovement {
  id        String       @id @default(cuid())
  productId String
  product   Product      @relation(fields: [productId], references: [id])
  quantity  Int
  type      MovementType
  reference String?
  notes     String?
  createdAt DateTime     @default(now())
  createdBy String

  @@index([productId])
}

// Service Order
model ServiceOrder {
  id                 String        @id @default(cuid())
  code               String
  status             OrderStatus   @default(AGENDADO)
  version            Int           @default(0)
  scheduledAt        DateTime
  startedAt          DateTime?
  completedAt        DateTime?
  vehicleId          String
  vehicle            Vehicle       @relation(fields: [vehicleId], references: [id])
  assignedToId       String
  assignedTo         User          @relation("AssignedTo", fields: [assignedToId], references: [id])
  createdById        String
  createdBy          User          @relation("CreatedBy", fields: [createdById], references: [id])
  tenantId           String
  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customerId         String?
  customer           Customer?     @relation(fields: [customerId], references: [id])
  subtotal           Decimal       @default(0) @db.Decimal(10, 2)
  discountType       DiscountType?
  discountValue      Decimal?      @db.Decimal(10, 2)
  total              Decimal       @default(0) @db.Decimal(10, 2)
  totalCommission    Decimal       @default(0) @db.Decimal(10, 2)
  notificationSentAt DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  items       OrderItem[]
  products    OrderProduct[]
  inspections Inspection[]
  payments    Payment[]

  @@index([tenantId, status])
  @@index([tenantId, scheduledAt])
  @@index([tenantId, assignedToId])
  @@index([code])
}

model OrderItem {
  id         String       @id @default(cuid())
  orderId    String
  order      ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  serviceId  String?
  service    Service?     @relation(fields: [serviceId], references: [id])
  customName String?
  price      Decimal      @db.Decimal(10, 2)
  quantity   Int          @default(1)
  notes      String?

  commissions OrderItemCommission[]

  @@index([orderId])
}

model OrderItemCommission {
  id              String                @id @default(cuid())
  orderItemId     String
  orderItem       OrderItem             @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  userId          String
  user            User                  @relation(fields: [userId], references: [id])
  commissionValue Decimal               @db.Decimal(10, 2)
  calculatedAt    DateTime              @default(now())
  settlementId    String?
  settlement      CommissionSettlement? @relation(fields: [settlementId], references: [id])

  @@index([userId])
  @@index([settlementId])
  @@index([orderItemId])
}

model CommissionSettlement {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId        String
  periodStart   DateTime
  periodEnd     DateTime
  totalPaid     Decimal  @db.Decimal(10, 2)
  paymentMethod String?
  paymentRef    String?
  createdAt     DateTime @default(now())
  createdBy     String

  items OrderItemCommission[]

  @@index([tenantId, userId])
  @@index([tenantId, periodStart, periodEnd])
}

model OrderProduct {
  id        String       @id @default(cuid())
  orderId   String
  order     ServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product      @relation(fields: [productId], references: [id])
  quantity  Int

  @@index([orderId])
}

// Inspection
model Inspection {
  id            String       @id @default(cuid())
  orderId       String
  type          String       @default("entrada") // entrada, intermediaria, final
  status        String       @default("em_andamento") // em_andamento, concluida
  order         ServiceOrder @relation(fields: [orderId], references: [id])
  version       Int          @default(0)
  checklistData Json         @default("{}")
  signatureUrl  String?
  signedAt      DateTime?
  signedVia     String?
  lastSyncedAt  DateTime?
  pendingSync   Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  items   InspectionItem[]
  damages InspectionDamage[]

  finalVideoUrl String?

  @@unique([orderId, type])
  @@index([orderId])
}

model InspectionItem {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  category     String     // "exterior", "rodas", "detalhes"
  itemKey      String     // "frente", "roda_de", "roda_dd", etc.
  label        String     // "Frente Completa", "Roda Dianteira Esquerda"
  isRequired   Boolean    @default(true)
  isCritical   Boolean    @default(false) // Warning vermelho
  photoUrl     String?
  notes        String?
  status       String     @default("pendente") // pendente, ok, com_avaria
  damageType   String?    // arranhao, amassado, trinca, mancha, risco, outro
  severity     String?    // leve, moderado, grave
  completedAt  DateTime?
  createdAt    DateTime   @default(now())

  @@unique([inspectionId, itemKey])
  @@index([inspectionId])
}

model InspectionDamage {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  position     String     // Parte do carro onde está o dano
  damageType   String
  photoUrl     String?
  notes        String?
  createdAt    DateTime   @default(now())

  @@index([inspectionId])
}



// Payments
model Payment {
  id         String        @id @default(cuid())
  orderId    String
  order      ServiceOrder  @relation(fields: [orderId], references: [id])
  method     PaymentMethod
  amount     Decimal       @db.Decimal(10, 2)
  paidAt     DateTime      @default(now())
  receivedBy String
  notes      String?

  @@index([orderId])
  @@index([paidAt])
}

// Notifications
model NotificationLog {
  id         String           @id @default(cuid())
  tenantId   String
  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderId    String?
  customerId String?
  type       NotificationType
  channel    String           @default("whatsapp")
  recipient  String
  message    String
  status     String           @default("pending")
  sentAt     DateTime?
  error      String?
  createdAt  DateTime         @default(now())

  @@index([tenantId])
  @@index([orderId])
}

// Audit Logs
model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  entityType String
  entityId   String?
  oldValue   Json?
  newValue   Json?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model MessageTemplate {
  id        String   @id @default(cuid())
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key       String
  name      String
  message   String   @db.Text
  variables String[]
  isActive  Boolean  @default(true)
  isSystem  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, key])
  @@index([tenantId])
}

// Configurações globais do sistema (admin only)
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  label     String
  type      String   @default("string") // string, number, boolean, json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// BILLING & SUBSCRIPTION MODELS
// ==========================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INCOMPLETE
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

model Subscription {
  id                   String             @id @default(cuid())
  tenantId             String             @unique
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  status               SubscriptionStatus @default(INCOMPLETE)
  billingInterval      BillingInterval    @default(MONTHLY)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  
  // Custom pricing (enterprise/promos)
  customMonthlyPrice   Decimal?           @db.Decimal(10, 2)
  
  // Founder tracking
  isFounder            Boolean            @default(false)
  founderExpiresAt     DateTime?
  
  // Promo code used at signup
  promoCodeId          String?
  promoCode            PromoCode?         @relation(fields: [promoCodeId], references: [id])
  promoDiscountApplied Boolean            @default(false)
  promoMonthsRemaining Int                @default(0) // For yearly: 3 months, for monthly: 1 month
  
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  payments SubscriptionPayment[]

  @@index([status])
  @@index([promoCodeId])
}

model SubscriptionPayment {
  id                    String       @id @default(cuid())
  subscriptionId        String
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  stripePaymentIntentId String?      @unique
  stripeInvoiceId       String?      @unique
  amount                Decimal      @db.Decimal(10, 2)
  currency              String       @default("brl")
  status                String       @default("pending") // succeeded, failed, pending
  paidAt                DateTime?
  createdAt             DateTime     @default(now())

  @@index([subscriptionId])
  @@index([status])
}

// ==========================================
// PROMO CODES & REFERRAL SYSTEM
// ==========================================

model PromoCode {
  id                String           @id @default(cuid())
  code              String           @unique // e.g., "FILMTECH15"
  
  // Referral: which tenant created this code
  referrerTenantId  String?
  referrerTenant    Tenant?          @relation("PromoCodeOwner", fields: [referrerTenantId], references: [id], onDelete: SetNull)
  
  // Discount configuration
  discountPercent   Int              @default(15) // 15%
  
  // Duration: how many months the discount applies
  // Monthly subscription: 1 month
  // Yearly subscription: 3 months
  monthlyDuration   Int              @default(1)
  yearlyDuration    Int              @default(3)
  
  // Validity
  isActive          Boolean          @default(true)
  maxUses           Int?             // null = unlimited
  usedCount         Int              @default(0)
  expiresAt         DateTime?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  usages            PromoCodeUsage[]
  subscriptions     Subscription[]

  @@index([code])
  @@index([referrerTenantId])
  @@index([isActive])
}

model PromoCodeUsage {
  id          String    @id @default(cuid())
  promoCodeId String
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  
  // Who used it
  usedByTenantId String
  
  // Discount applied
  discountAmount Decimal   @db.Decimal(10, 2)
  originalAmount Decimal   @db.Decimal(10, 2)
  
  usedAt      DateTime  @default(now())

  @@index([promoCodeId])
  @@index([usedByTenantId])
}

// ==========================================
// FOUNDER SLOTS CONTROL
// ==========================================

model FounderSlot {
  id         String   @id @default(cuid())
  totalSlots Int      @default(15)
  usedSlots  Int      @default(0)
  updatedAt  DateTime @updatedAt
}

// ==========================================
// WEBHOOK LOGS (for debugging & retry)
// ==========================================

model WebhookLog {
  id            String   @id @default(cuid())
  source        String   @default("stripe") // stripe, clerk, etc.
  event         String
  externalId    String   @unique // stripeEventId, etc.
  status        String   @default("pending") // pending, success, failed
  payload       Json
  errorMessage  String?
  attempts      Int      @default(1)
  processedAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([source, event])
  @@index([status])
  @@index([createdAt])
}
